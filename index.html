<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="all.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet.css">
    <link rel="stylesheet" type="text/css" href="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet-geocoder/0.0.1-beta.5/esri-leaflet-geocoder.css">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=no, shrink-to-fit=no, minimum-scale=1, maximum-scale=1">
    <meta property="og:title" content="WHO 理你啊 ! 台灣口罩數量查詢網">
    <meta property="og:description" content="台灣口罩數量查詢網">
    <meta name='description' content="WHO 理你啊 ! 台灣口罩數量查詢網">
    <meta property="og:type" content="website">
    <meta property="og:image" content="WHO.jpg">
    <style>
        #map {
        height: 600px;
    }

    @media (max-width: 576px) {
        #map {
            height: 200px;
        }
    }

    @media (max-width: 992px) {
        #map {
            height: 500px;
        }

        #meme {
        	display: none;
        }
    }

    #mapSearchContainer {
        position: fixed;
        top: 20px;
        right: 40px;
        height: 30px;
        width: 180px;
        z-index: 110;
        font-size: 10pt;
        color: #5d5d5d;
        border: solid 1px #bbb;
        background-color: #f8f8f8;
    }

    .pointer {
        position: absolute;
        top: 86px;
        left: 60px;
        z-index: 99999;
    }
    </style>
    <title>WHO 理你啊 ! 台灣口罩數量查詢網</title>
</head>

<body>
    <h1 class="text-center my-3">WHO 理你啊 ! 台灣口罩數量查詢網</h1>
    <section class="container">
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="d-flex" style="border-top:1px solid black;border-right:1px solid black;border-left:1px solid black;">
                    <input id="search" class="form-control rounded-0" type="text">
                    <button id="btn-search" class="btn btn-primary btn-mid rounded-0">搜尋藥局</button>
                </div>
                <div id="search-result" style="height: 200px;overflow:scroll;overflow-x:hidden;border:1px solid black;">
                </div>
                <img src="daway.jpg" alt="daway" id="meme" class="w-100 mt-3" style="border:1px solid black" onmouseover="mouseOver()" onmouseout="mouseOut()">
            </div>
            <div class="col-md-9">
                <div id="map" style="border:1px solid black"></div>
                <div class="pointer"></div> <!-- partial -->
                <article class="mx-3">
                    <div class="row">
                        <div class="col-md mt-3">
                            <div class="font-weight-bolder">下載區 -</div>
                            <a href="http://data.nhi.gov.tw/Datasets/Download.ashx?rid=A21030000I-D50001-001&l=https://data.nhi.gov.tw/resource/mask/maskdata.csv" class="btn btn-success mt-1 px-2" title="點擊下載">健保特約機構口罩剩餘數量明細清單.CSV</a>
                        </div>
                        <div class="col-md mt-3">
                            <div class="font-weight-bolder">資料更新頻率 -</div>
                            <div class="mt-1">每 30 秒一次</div>
                        </div>
                        <div class="col-md-12 mt-3">
                            <!-- FB -->
        <div class="fb-like text-center text-white" data-href="https://www.facebook.com/nhi.gov.tw/" data-width="" data-layout="standard" data-action="like" data-size="small" data-share="true"></div>
        <!-- FB -->
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </section>
    <footer class="bg-secondary text-center mt-5 py-2">
        <div class="text-white">資料來源 : 健保署</div>
        <div class="text-white">維護者 : <a href="https://github.com/TWyeehome" class="text-white" title="安安" target="_blank">Michael</a></div>
        <div class="text-white">email : <a href="mailto:k123456789370@yahoo.com.tw" class="text-white">k123456789370@yahoo.com.tw</a></div>
        <div class="text-white">感謝中華民國行政院政務委員唐鳳的推動</div>
        
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet-src.js.map"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.6.0/leaflet-src.js"></script>
    <script src="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet/0.0.1-beta.5/esri-leaflet.js"></script>
    <script src="https://cdn-geoweb.s3.amazonaws.com/esri-leaflet-geocoder/0.0.1-beta.5/esri-leaflet-geocoder.js"></script>
    <script src="Control.FullScreen.js"></script>
    <!-- FB -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v6.0"></script>
    <script>
    // meme hover
    function mouseOver() {
        document.getElementById('meme').src = 'way.jpg';
    };

    function mouseOut() {
        document.getElementById('meme').src = 'daway.jpg';
    };

    // 地圖設定
    let base = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.png', {
        minZoom: 7,
        maxZoom: 18
    });

    let map = L.map("map", {
        layers: [base],
        center: new L.LatLng(23.817844, 119.990917),
        zoom: 5,
        fullscreenControl: true,
        fullscreenControlOptions: { // optional
            title: '全螢幕',
            titleCancel: '離開全螢幕'
        }
    });

    let myRenderer = L.canvas({ padding: 0 });

    let circleMarkerOptions = null;
    let infoStr = '';
    let getMask = new XMLHttpRequest();
    getMask.open('GET', 'https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json?fbclid=IwAR2vd7FqcvO-XHnvXfFLwzb54ulKEEUc1Is0FN3UepRU_Z2Wk49fa50o1C4', true);
    getMask.send(null);
    getMask.onload = () => {
        let getMaskData = JSON.parse(getMask.responseText);
        console.log(getMaskData.features);

        // 搜尋藥局 function
        function search() {
            if (document.getElementById('search').value == '') {
                alert('請輸入關鍵字齁!');
                return
            };
            // 地圖回歸中心點
            map.setView([23.817844, 119.990917], 5);

            // 開始搜尋
            let result = '';
            let resultTotal = 0;
            for (let num = 0; num < getMaskData.features.length; num++) {
                if (getMaskData.features[num].properties.name.indexOf(document.getElementById('search').value) != -1) {
                    //console.log(getMaskData.features[num].properties.name);
                    result += '<a href="#" class="result-link d-block border" style="padding:2px 8px; margin:2px 0;" data-info="' + num + '">' + getMaskData.features[num].properties.name + '</a>';
                    resultTotal += 1;
                };
            };

            document.getElementById('search-result').innerHTML = '<div class="text-center" style="margin:16px 0 14px 0;">得到筆數 : ' + resultTotal + '</div>' + result;

            for (let x = 0; x < document.querySelectorAll('.result-link').length; x++) {
                document.querySelectorAll('.result-link')[x].addEventListener('click', () => {
                    //console.log(document.querySelectorAll('.result-link')[x].dataset.loa);
                    //console.log(document.querySelectorAll('.result-link')[x].dataset.geo);
                    //console.log(document.querySelectorAll('.result-link')[x].dataset.info);

                    // 彈跳 info window
                    map.setView([getMaskData.features[document.querySelectorAll('.result-link')[x].dataset.info].geometry.coordinates[1], getMaskData.features[document.querySelectorAll('.result-link')[x].dataset.info].geometry.coordinates[0]], 25);
                    markers[document.querySelectorAll('.result-link')[x].dataset.info].openPopup();
                });
            };
        };

        // 搜尋藥局
        document.getElementById('btn-search').addEventListener('click', () => {
            search();
        });

        // 院染
        let markers = [];
        for (var i = 0; i < getMaskData.features.length; i++) {
            // 內文
            infoStr =
                '<div class="border-bottom">名稱 : ' + getMaskData.features[i].properties.name + '</div>' +
                '<div class="border-bottom my-1">電話 : ' + getMaskData.features[i].properties.phone + '</div>' +
                '<div class="border-bottom">地址 : ' + getMaskData.features[i].properties.address + '</div>' +
                '<div class="border-bottom my-1">成人口罩數量 : ' + getMaskData.features[i].properties.mask_adult + '</div>' +
                '<div class="border-bottom">兒童口罩數量 : ' + getMaskData.features[i].properties.mask_child + '</div>' +
                '<div class="border-bottom my-1">備註 : ' + getMaskData.features[i].properties.note + '</div>';

            // marker 顏色判定
            if (getMaskData.features[i].properties.mask_adult + getMaskData.features[i].properties.mask_child == 0) {
                circleMarkerOptions = {
                    weight: 1,
                    fillColor: "red",
                    color: "black",
                    opacity: 1
                };
                markers.push(L.circleMarker(getRandomLatLng(), circleMarkerOptions).addTo(map).bindPopup(infoStr));

            } else if (getMaskData.features[i].properties.mask_adult + getMaskData.features[i].properties.mask_child < 100) {
                circleMarkerOptions = {
                    weight: 1,
                    fillColor: "yellow",
                    color: "black",
                    opacity: 1
                };
                markers.push(L.circleMarker(getRandomLatLng(), circleMarkerOptions).addTo(map).bindPopup(infoStr));
            } else {
                circleMarkerOptions = {
                    weight: 1,
                    fillColor: "green",
                    color: "black",
                    opacity: 1
                };
                markers.push(L.circleMarker(getRandomLatLng(), circleMarkerOptions).addTo(map).bindPopup(infoStr));
            };
        };

        // 取得座標
        function getRandomLatLng() {
            return [
                getMaskData.features[i].geometry.coordinates[1], getMaskData.features[i].geometry.coordinates[0]
            ];
        };
    };

    // 地圖 layer
    L.Control.Watermark = L.Control.extend({
        onAdd: function(map) {
            let layer = L.DomUtil.create('div');
            layer.innerHTML =
                '<section class="bg-white rounded p-1" style="opacity:0.8;">' +
                '<div>口罩數為 0 : 紅標</div>' +
                '<div>口罩數小於 100 : 黃標</div>' +
                '<div>口罩數大於 100 : 綠標</div>' +
                '</section>';
            return layer;
        },
        onRemove: function(map) {
            // Nothing to do here
        }
    });

    L.control.watermark = function(opts) {
        return new L.Control.Watermark(opts);
    };

    L.control.watermark({ position: 'bottomleft' }).addTo(map);


    // 找地點
    var searchControl = new L.esri.Controls.Geosearch().addTo(map);

    var results = new L.LayerGroup().addTo(map);
    </script>
    <!-- GA -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-157993084-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-157993084-1');
    </script>
</body>

</html>